<!-- ... todo o seu HTML at√© a tag <footer> ... -->
<footer>
    <p>PetID &copy; 2023 - Mantenha seu pet seguro e identificado</p>
</footer>

<!-- Adicione os scripts do Firebase ANTES do seu script principal -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function( ) {
    // =================================================================
    // PASSO 1: COLE A SUA CONFIGURA√á√ÉO DO FIREBASE AQUI
    // =================================================================
    const firebaseConfig = {
        apiKey: "SUA_API_KEY",
        authDomain: "SEU_AUTH_DOMAIN",
        projectId: "SEU_PROJECT_ID",
        storageBucket: "SEU_STORAGE_BUCKET",
        messagingSenderId: "SEU_MESSAGING_SENDER_ID",
        appId: "SUA_APP_ID"
    };

    // Inicializar o Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore(); // Nosso banco de dados!

    // Elementos da interface (mesmos de antes)
    const authArea = document.getElementById('authArea');
    const appArea = document.getElementById('appArea');
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const petForm = document.getElementById('petForm');
    const linkCard = document.getElementById('linkCard');
    const petLink = document.getElementById('petLink');
    const copyBtn = document.getElementById('copyBtn');
    const newPetBtn = document.getElementById('newPetBtn');
    const petList = document.getElementById('petList');
    const noPetsMessage = document.getElementById('noPetsMessage');

    // Estado da aplica√ß√£o
    let currentUser = null;
    let currentPetLink = null;

    // =================================================================
    // L√ìGICA PRINCIPAL
    // =================================================================

    // Verificar se h√° um pet na URL ao carregar a p√°gina
    checkUrlForPet();

    // Monitorar o estado de autentica√ß√£o do Firebase
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usu√°rio est√° logado
            currentUser = user;
            showAppArea();
        } else {
            // Usu√°rio n√£o est√° logado
            currentUser = null;
            // Apenas exibe a √°rea de login se n√£o estivermos na p√°gina de um pet
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('pet')) {
                showAuthArea();
            }
        }
    });

    // Eventos de formul√°rio
    registerForm.addEventListener('submit', handleRegister);
    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    petForm.addEventListener('submit', handlePetSubmit);
    copyBtn.addEventListener('click', handleCopy);
    newPetBtn.addEventListener('click', handleNewPet);

    // Fun√ß√µes de autentica√ß√£o (agora com Firebase)
    function handleRegister(e) {
        e.preventDefault();
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;

        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                return userCredential.user.updateProfile({
                    displayName: name
                }).then(() => {
                    showNotification('Conta criada com sucesso! Fa√ßa login.', 'success');
                    registerForm.reset();
                });
            })
            .catch(error => {
                showNotification(`Erro: ${error.message}`, 'error');
            });
    }

    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                showNotification(`Bem-vindo(a), ${userCredential.user.displayName}!`, 'success');
                // O onAuthStateChanged vai cuidar de mostrar a √°rea do app
            })
            .catch(error => {
                showNotification('E-mail ou senha incorretos!', 'error');
            });
    }

    function handleLogout() {
        auth.signOut().then(() => {
            showNotification('Logout realizado com sucesso!', 'success');
            // O onAuthStateChanged vai cuidar de mostrar a √°rea de login
        });
    }

    function showAuthArea() {
        authArea.classList.remove('hidden');
        appArea.classList.add('hidden');
        userInfo.classList.add('hidden');
    }

    function showAppArea() {
        authArea.classList.add('hidden');
        appArea.classList.remove('hidden');
        userInfo.classList.remove('hidden');
        userName.textContent = currentUser.displayName;
        loadUserPets();
    }

    // Fun√ß√µes de pets (agora com Firestore)
    async function loadUserPets() {
        if (!currentUser) return;

        // Busca pets no Firestore onde o userId √© igual ao do usu√°rio logado
        const snapshot = await db.collection('pets').where('userId', '==', currentUser.uid).get();
        const userPets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        updatePetList(userPets);
    }

    async function handlePetSubmit(e) {
        e.preventDefault();
        
        const petData = {
            userId: currentUser.uid,
            name: document.getElementById('petName').value,
            type: document.getElementById('petType').value,
            breed: document.getElementById('petBreed').value,
            ownerName: document.getElementById('ownerName').value,
            ownerPhone: document.getElementById('ownerPhone').value,
            additionalInfo: document.getElementById('additionalInfo').value,
            date: new Date().toLocaleDateString('pt-BR')
        };

        try {
            // Adiciona o pet ao Firestore, que gera um ID autom√°tico
            const docRef = await db.collection('pets').add(petData);
            
            // Gera o link usando o ID do Firestore
            generateLink(docRef.id);
            
            linkCard.classList.remove('hidden');
            linkCard.scrollIntoView({ behavior: 'smooth' });
            showNotification('Pet cadastrado com sucesso!', 'success');
            
            // Recarrega a lista de pets
            loadUserPets();
        } catch (error) {
            console.error("Erro ao cadastrar pet: ", error);
            showNotification('Erro ao cadastrar pet.', 'error');
        }
    }

    function generateLink(petId) {
        const baseUrl = window.location.href.split('?')[0];
        const petUrl = `${baseUrl}?pet=${petId}`;
        
        petLink.href = petUrl;
        petLink.textContent = petUrl;
        currentPetLink = petUrl;
    }

    function updatePetList(pets) {
        petList.innerHTML = '';
        if (pets.length === 0) {
            noPetsMessage.classList.remove('hidden');
            return;
        }
        
        noPetsMessage.classList.add('hidden');
        
        pets.forEach(pet => {
            const petCard = document.createElement('div');
            petCard.className = 'pet-card';
            
            petCard.innerHTML = `
                <div class="pet-name">${pet.name}</div>
                <div class="pet-info">
                    <p><strong>Tipo:</strong> ${pet.type}</p>
                    <p><strong>Ra√ßa:</strong> ${pet.breed}</p>
                    <p><strong>Dono:</strong> ${pet.ownerName}</p>
                    <p><strong>Telefone:</strong> ${pet.ownerPhone}</p>
                    ${pet.additionalInfo ? `<p><strong>Informa√ß√µes:</strong> ${pet.additionalInfo}</p>` : ''}
                    <p><strong>Cadastrado em:</strong> ${pet.date}</p>
                </div>
                <div class="pet-actions">
                    <button class="btn-view-link" data-id="${pet.id}">Ver Link</button>
                    <button class="btn-delete btn-danger" data-id="${pet.id}">Excluir</button>
                </div>
            `;
            petList.appendChild(petCard);
        });
        
        // Adicionar eventos aos bot√µes
        document.querySelectorAll('.btn-view-link').forEach(btn => {
            btn.addEventListener('click', function() {
                const petId = this.getAttribute('data-id');
                generateLink(petId);
                linkCard.classList.remove('hidden');
                linkCard.scrollIntoView({ behavior: 'smooth' });
            });
        });
        
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async function() {
                const petId = this.getAttribute('data-id');
                if (confirm('Tem certeza que deseja excluir este pet?')) {
                    try {
                        await db.collection('pets').doc(petId).delete();
                        showNotification('Pet exclu√≠do com sucesso!', 'success');
                        loadUserPets(); // Recarrega a lista
                    } catch (error) {
                        showNotification('Erro ao excluir pet.', 'error');
                    }
                }
            });
        });
    }

    function handleCopy() {
        if (currentPetLink) {
            navigator.clipboard.writeText(currentPetLink)
                .then(() => showNotification('Link copiado!', 'success'))
                .catch(() => showNotification('Erro ao copiar link', 'error'));
        }
    }

    function handleNewPet() {
        petForm.reset();
        linkCard.classList.add('hidden');
        currentPetLink = null;
        petForm.scrollIntoView({ behavior: 'smooth' });
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    async function checkUrlForPet() {
        const urlParams = new URLSearchParams(window.location.search);
        const petId = urlParams.get('pet');
        
        if (petId) {
            try {
                // Busca o pet espec√≠fico no Firestore pelo ID
                const doc = await db.collection('pets').doc(petId).get();
                
                if (doc.exists) {
                    showPetInfo(doc.data());
                } else {
                    showPetNotFound();
                }
            } catch (error) {
                console.error("Erro ao buscar pet: ", error);
                showPetNotFound();
            }
        }
    }

    function showPetNotFound() {
        document.body.innerHTML = `
            <div class="container">
                <div class="card">
                    <h2>Pet n√£o encontrado</h2>
                    <p>O link que voc√™ acessou n√£o corresponde a nenhum pet cadastrado.</p>
                    <a href="${window.location.origin + window.location.pathname}">Voltar para o PetID</a>
                </div>
            </div>
        `;
    }

    function showPetInfo(pet) {
        document.body.innerHTML = `
            <header>
                <div class="logo">
                    <div class="logo-icon">üêæ</div>
                    <div><h1>PetID</h1><p>Informa√ß√µes do Pet</p></div>
                </div>
            </header>
            <div class="container">
                <div class="card">
                    <h2>Informa√ß√µes do Pet Encontrado</h2>
                    <div class="pet-info">
                        <p><strong>Nome:</strong> ${pet.name}</p>
                        <p><strong>Tipo:</strong> ${pet.type}</p>
                        <p><strong>Ra√ßa:</strong> ${pet.breed}</p>
                        <p><strong>Dono:</strong> ${pet.ownerName}</p>
                        <p><strong>Telefone do Dono:</strong> ${pet.ownerPhone}</p>
                        ${pet.additionalInfo ? `<p><strong>Informa√ß√µes Adicionais:</strong> ${pet.additionalInfo}</p>` : ''}
                    </div>
                    <p style="margin-top: 1.5rem; padding: 1rem; background-color: #f0f8ff; border-radius: 5px;">
                        <strong>Se voc√™ encontrou este pet, entre em contato com o dono pelo telefone informado acima.</strong>
                    </p>
                    <a href="${window.location.origin + window.location.pathname}" style="display: inline-block; margin-top: 1rem;">Voltar para o PetID</a>
                </div>
            </div>
        `;
    }
});
</script>
